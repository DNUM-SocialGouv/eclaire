<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8" />
    <title>Export XLS Progress</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 1rem 40px;
            background: #f5f5f5;
        }

        h1 {
            margin-bottom: 4rem;
        }

        button {
            padding: .8rem 1rem;
            font-size: 17px;
            font-weight: bold;
            cursor: pointer;
            border: none;
            border-radius: 6px;
            background: #4299e1;
            color: #fff;
            transition: .3s;
        }

        button:hover {
            background: #2b6cb0;
        }

        button:disabled {
            background: #999;
            cursor: not-allowed;
        }

        #progressContainer {
            width: 100%;
            background: #ddd;
            border-radius: 8px;
            margin-top: 30px;
            overflow: hidden;
            height: 40px;
            box-shadow: inset 0 2px 6px rgba(0, 0, 0, 0.15);
        }

        #progressBar {
            width: 0%;
            height: 100%;
            background: linear-gradient(90deg, #4caf50, #66bb6a);
            text-align: center;
            color: #fff;
            line-height: 35px;
            font-weight: bold;
            transition: width 0.3s ease;
        }

        #statusText {
            margin-top: 15px;
            font-weight: bold;
        }
    </style>
</head>

<body>

    <h1>Export XLS</h1>

    <button id="startBtn">Lancer l’export</button>

    <div id="progressContainer">
        <div id="progressBar">0%</div>
    </div>

    <div id="statusText"></div>

    <script>
        const startBtn = document.getElementById('startBtn')
        const progressBar = document.getElementById('progressBar')
        const statusText = document.getElementById('statusText')

        let visualProgress = 0
        let pollingActive = false

        function updateBar(value) {
            const safe = Math.min(100, Math.max(0, value))
            progressBar.style.width = safe + '%'
            progressBar.textContent = safe + '%'
        }

        function resetUI() {
            visualProgress = 0
            updateBar(0)
            statusText.textContent = ""
        }

        function formatDateForFile() {
            const d = new Date()
            return `${String(d.getDate()).padStart(2, '0')}-${String(d.getMonth() + 1).padStart(2, '0')}-${d.getFullYear()}`
        }

        function updatePhaseUI(phase) {
            switch (phase) {
                case 'extracting':
                    statusText.textContent = "Extraction des données..."
                    break
                case 'building-file':
                    statusText.textContent = "Génération du fichier Excel..."
                    break
                case 'ready':
                    statusText.textContent = "Téléchargement..."
                    break
            }
        }

        async function downloadFile(jobId) {
            const response = await fetch(`/api/export/download/${jobId}`)
            if (!response.ok) {
                throw new Error("Erreur lors du téléchargement")
            }

            const blob = await response.blob()
            const fileName = `export_eclaire_${formatDateForFile()}.xlsx`

            const url = window.URL.createObjectURL(blob)
            const a = document.createElement('a')
            a.href = url
            a.download = fileName
            document.body.appendChild(a)
            a.click()
            a.remove()
            window.URL.revokeObjectURL(url)
        }

        async function pollStatus(jobId) {
            if (!pollingActive) return

            try {
                const res = await fetch(`/api/export/status/${jobId}`)
                if (!res.ok) throw new Error("Erreur serveur")

                const data = await res.json()

                updatePhaseUI(data.phase)

                // Progress handling
                if (typeof data.progress === 'number') {
                    if (data.status !== 'done') {
                        const safeProgress = Math.min(data.progress, 99)
                        if (safeProgress > visualProgress) {
                            visualProgress = safeProgress
                            updateBar(visualProgress)
                        }
                    }
                }

                // Ready for download
                if (data.status === 'done' && data.phase === 'ready') {
                    pollingActive = false

                    visualProgress = 99
                    updateBar(99)

                    await downloadFile(jobId)

                    // 100% seulement après download OK
                    visualProgress = 100
                    updateBar(100)

                    statusText.textContent = "Export terminé ✅"
                    startBtn.disabled = false
                    return
                }

                if (data.status === 'error') {
                    pollingActive = false
                    startBtn.disabled = false
                    statusText.textContent = "Erreur lors de l’export ❌"
                    alert(data.error || "Erreur inconnue")
                    return
                }

                setTimeout(() => pollStatus(jobId), 2000)

            } catch (err) {
                pollingActive = false
                startBtn.disabled = false
                statusText.textContent = "Erreur ❌"
                alert(err.message)
            }
        }

        startBtn.addEventListener('click', async () => {
            startBtn.disabled = true
            resetUI()
            statusText.textContent = "Initialisation..."

            try {
                const res = await fetch('/api/export/start', { method: 'POST' })
                if (!res.ok) throw new Error("Impossible de démarrer")

                const data = await res.json()

                pollingActive = true
                pollStatus(data.jobId)

            } catch (err) {
                startBtn.disabled = false
                statusText.textContent = "Erreur ❌"
                alert(err.message)
            }
        })
    </script>

</body>

</html>